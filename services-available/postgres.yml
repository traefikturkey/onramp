networks:
  traefik:
    external: true

# description: Shared PostgreSQL database server for multiple services
# https://hub.docker.com/_/postgres
#
# This is a shared postgres:16 instance used by multiple OnRamp services.
# Services automatically create their databases via scaffold integration.
#
# Setup:
# 1. Set PG_PASS in services-enabled/.env
# 2. make enable-service postgres
# 3. make restart
#
# Database Management:
# - Databases are auto-created when services with "# database: postgres" metadata are enabled
# - Manual operations: cd sietch/scripts && ./postgres_manager.py [list-databases|create-db|drop-db|console]
#
# Services using this database:
# - authentik, dockerizalo, healthchecks, kaizoku, kaneo, mediamanager, n8n, nocodb, tandoor
#
# Credentials: All services use shared PG_USER/PG_PASS from .env

services:
  postgres:
    image: postgres:${POSTGRES_DOCKER_TAG:-16}
    env_file:
      - ./services-enabled/postgres.env
    container_name: ${POSTGRES_CONTAINER_NAME:-postgres}
    restart: ${POSTGRES_RESTART:-unless-stopped}
    networks:
      - traefik
    volumes:
      - ${POSTGRES_DIR:-./media/databases/postgres/data}:/var/lib/postgresql/data
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
      - POSTGRES_PASSWORD=${PG_PASS:?database password required}
      - POSTGRES_USER=${PG_USER:-admin}
      - POSTGRES_DB=${PG_DB:-admin}
    ports:
      - 5432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-admin}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - joyride.host.name=${POSTGRES_CONTAINER_NAME:-postgres}.${HOST_DOMAIN}
      - traefik.enable=false
      - com.centurylinklabs.watchtower.enable=${PG_WATCHTOWER_ENABLED:-true}
      - autoheal=true
