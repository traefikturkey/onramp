networks:
  traefik:
    external: true

# description: Shared Valkey cache server for multiple services
# https://valkey.io
# https://hub.docker.com/r/valkey/valkey
#
# This is a shared valkey:latest instance used by multiple OnRamp services.
# Services automatically get assigned database numbers (0-15) via scaffold integration.
#
# Setup:
# 1. Optionally set VALKEY_PASS in services-enabled/.env (if authentication needed)
# 2. make enable-service valkey
# 3. make restart
#
# Database Management:
# - Database numbers are auto-assigned when services with "# cache: valkey" metadata are enabled
# - Assignments tracked in ./etc/.valkey_assignments.json
# - Manual operations: cd sietch/scripts && ./valkey_manager.py [list-dbs|assign-db|get-db]
#
# Services using this cache:
# - (will be populated as services are migrated)
#
# Note: Valkey supports 16 databases (0-15) per instance

services:
  valkey:
    image: valkey/valkey:${VALKEY_DOCKER_TAG:-latest}
    container_name: ${VALKEY_CONTAINER_NAME:-valkey}
    restart: ${VALKEY_RESTART:-unless-stopped}
    networks:
      - traefik
    volumes:
      - ${VALKEY_DIR:-./media/databases/valkey/data}:/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
    healthcheck:
      test: ["CMD-SHELL", "valkey-cli ping | grep PONG"]
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 3s
    ports:
      - 6379:6379
    labels:
      - joyride.host.name=${VALKEY_CONTAINER_NAME:-valkey}.${HOST_DOMAIN}
      - traefik.enable=false
      - com.centurylinklabs.watchtower.enable=${VALKEY_WATCHTOWER_ENABLED:-true}
      - autoheal=true
