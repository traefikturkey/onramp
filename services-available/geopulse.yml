networks:
  traefik:
    external: true

# description: A self-hosted location tracking and analysis platform
# https://github.com/tess1o/geopulse
# https://tess1o.github.io/geopulse/docs/getting-started/introduction

services:
  geopulse-postgres:
    image: postgis/postgis:17-3.5
    env_file:
      - ./services-enabled/geopulse.env
    container_name: ${GEOPULSE_CONTAINER_NAME:-geopulse-postgres}
    restart: ${GEOPULSE_RESTART:-unless-stopped}
    mem_limit: ${GEOPULSE_MEM_LIMIT:-200g}
    networks:
      - traefik
    volumes:
      - ./etc/geopulse/postgres:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
      - POSTGRES_USER=${GEOPULSE_POSTGRES_USERNAME:-geopulse-user}
      - POSTGRES_PASSWORD=${GEOPULSE_POSTGRES_PASSWORD:-change-this-secure-password}
      - POSTGRES_DB=${GEOPULSE_POSTGRES_DB:-geopulse}
    # Conservative PostgreSQL settings optimized for minimal resource usage
    # Suitable for small deployments and idle GPS tracking workloads
    command: >
      postgres
      -c shared_buffers=${GEOPULSE_POSTGRES_SHARED_BUFFERS:-256MB}
      -c work_mem=${GEOPULSE_POSTGRES_WORK_MEM:-8MB}
      -c maintenance_work_mem=${GEOPULSE_POSTGRES_MAINTENANCE_WORK_MEM:-64MB}
      -c effective_cache_size=${GEOPULSE_POSTGRES_EFFECTIVE_CACHE_SIZE:-1GB}
      -c max_wal_size=${GEOPULSE_POSTGRES_MAX_WAL_SIZE:-512MB}
      -c checkpoint_completion_target=${GEOPULSE_POSTGRES_CHECKPOINT_TARGET:-0.9}
      -c wal_buffers=${GEOPULSE_POSTGRES_WAL_BUFFERS:-16MB}
      -c random_page_cost=${GEOPULSE_POSTGRES_RANDOM_PAGE_COST:-1.1}
      -c effective_io_concurrency=${GEOPULSE_POSTGRES_IO_CONCURRENCY:-100}
      -c autovacuum_naptime=${GEOPULSE_POSTGRES_AUTOVACUUM_NAPTIME:-60s}
      -c autovacuum_vacuum_scale_factor=${GEOPULSE_POSTGRES_VACUUM_SCALE_FACTOR:-0.2}
      -c log_min_duration_statement=${GEOPULSE_POSTGRES_LOG_SLOW_QUERIES:-5000}
      -c track_io_timing=on
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${GEOPULSE_POSTGRES_USERNAME:-geopulse-user} -d ${GEOPULSE_POSTGRES_DB:-geopulse}"]
      interval: 5s
      timeout: 5s
      retries: 5
    labels:
      - com.centurylinklabs.watchtower.enable=${GEOPULSE_WATCHTOWER_ENABLED:-true}
      - autoheal=${GEOPULSE_AUTOHEAL_ENABLED:-true}

  geopulse-backend:
    image: ghcr.io/tess1o/geopulse-backend:${GEOPULSE_DOCKER_TAG:-native-latest}
    env_file:
      - ./services-enabled/geopulse.env
    container_name: ${GEOPULSE_CONTAINER_NAME:-geopulse-backend}
    restart: ${GEOPULSE_RESTART:-unless-stopped}
    mem_limit: ${GEOPULSE_MEM_LIMIT:-200g}
    networks:
      - traefik
    volumes:
      - ./etc/geopulse/keys:/app/keys
      - /etc/localtime:/etc/localtime:ro
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
      - GEOPULSE_UI_URL=https://${GEOPULSE_HOST_NAME:-geopulse}.${HOST_DOMAIN}
      - GEOPULSE_AUTH_SECURE_COOKIES=true
      - GEOPULSE_POSTGRES_HOST=${GEOPULSE_POSTGRES_HOST:-geopulse-postgres}
      - GEOPULSE_POSTGRES_PORT=${GEOPULSE_POSTGRES_PORT:-5432}
      - GEOPULSE_POSTGRES_DB=${GEOPULSE_POSTGRES_DB:-geopulse}
      - GEOPULSE_POSTGRES_USERNAME=${GEOPULSE_POSTGRES_USERNAME:-geopulse-user}
      - GEOPULSE_POSTGRES_PASSWORD=${GEOPULSE_POSTGRES_PASSWORD:-change-this-secure-password}
      - GEOPULSE_OIDC_ENABLED=${GEOPULSE_OIDC_ENABLED:-false}
      - GEOPULSE_POSTGRES_URL=jdbc:postgresql://${GEOPULSE_POSTGRES_HOST:-geopulse-postgres}:${GEOPULSE_POSTGRES_PORT:-5432}/${GEOPULSE_POSTGRES_DB:-geopulse}
      - GEOPULSE_AUTH_REGISTRATION_ENABLED=${GEOPULSE_AUTH_REGISTRATION_ENABLED:-true}
      - GEOPULSE_AUTH_PASSWORD_REGISTRATION_ENABLED=${GEOPULSE_AUTH_PASSWORD_REGISTRATION_ENABLED:-true}
      - GEOPULSE_AUTH_OIDC_REGISTRATION_ENABLED=${GEOPULSE_AUTH_OIDC_REGISTRATION_ENABLED:-true}
      - GEOPULSE_OIDC_PROVIDER_GOOGLE_ENABLED=${GEOPULSE_OIDC_PROVIDER_GOOGLE_ENABLED:-false}
      - GEOPULSE_OIDC_PROVIDER_GOOGLE_CLIENT_ID=${GEOPULSE_OIDC_PROVIDER_GOOGLE_CLIENT_ID:-}
      - GEOPULSE_OIDC_PROVIDER_GOOGLE_CLIENT_SECRET=${GEOPULSE_OIDC_PROVIDER_GOOGLE_CLIENT_SECRET:-}
      - GEOPULSE_OIDC_PROVIDER_GOOGLE_DISCOVERY_URL=${GEOPULSE_OIDC_PROVIDER_GOOGLE_DISCOVERY_URL:-https://accounts.google.com/.well-known/openid-configuration}
      - GEOPULSE_OIDC_PROVIDER_GENERIC_ENABLED=${GEOPULSE_OIDC_PROVIDER_GENERIC_ENABLED:-false}
      - GEOPULSE_OIDC_PROVIDER_GENERIC_NAME=${GEOPULSE_OIDC_PROVIDER_GENERIC_NAME:-}
      - GEOPULSE_OIDC_PROVIDER_GENERIC_CLIENT_ID=${GEOPULSE_OIDC_PROVIDER_GENERIC_CLIENT_ID:-}
      - GEOPULSE_OIDC_PROVIDER_GENERIC_CLIENT_SECRET=${GEOPULSE_OIDC_PROVIDER_GENERIC_CLIENT_SECRET:-}
      - GEOPULSE_OIDC_PROVIDER_GENERIC_DISCOVERY_URL=${GEOPULSE_OIDC_PROVIDER_GENERIC_DISCOVERY_URL:-}
    labels:
      - com.centurylinklabs.watchtower.enable=${GEOPULSE_WATCHTOWER_ENABLED:-true}
      - autoheal=${GEOPULSE_AUTOHEAL_ENABLED:-true}
    depends_on:
      geopulse-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/health || exit 1"]
      interval: 3s
      timeout: 2s
      retries: 20
      start_period: 5s

  geopulse-ui:
    image: ghcr.io/tess1o/geopulse-ui:${GEOPULSE_DOCKER_TAG:-latest}
    env_file:
      - ./services-enabled/geopulse.env
    container_name: ${GEOPULSE_CONTAINER_NAME:-geopulse-ui}
    restart: ${GEOPULSE_RESTART:-unless-stopped}
    mem_limit: ${GEOPULSE_MEM_LIMIT:-200g}
    networks:
      - traefik
    volumes:
      - ./etc/geopulse/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
      - CLIENT_MAX_BODY_SIZE=1000M
      - GEOPULSE_BACKEND_URL=http://geopulse-backend:8080
      - GEOPULSE_UI_URL=https://${GEOPULSE_HOST_NAME:-geopulse}.${HOST_DOMAIN}
      - GEOPULSE_AUTH_REGISTRATION_ENABLED=${GEOPULSE_AUTH_REGISTRATION_ENABLED:-true}
      - GEOPULSE_AUTH_PASSWORD_REGISTRATION_ENABLED=${GEOPULSE_AUTH_PASSWORD_REGISTRATION_ENABLED:-true}
      - GEOPULSE_AUTH_OIDC_REGISTRATION_ENABLED=${GEOPULSE_AUTH_OIDC_REGISTRATION_ENABLED:-true}
      - GEOPULSE_OIDC_PROVIDER_GOOGLE_ENABLED=${GEOPULSE_OIDC_PROVIDER_GOOGLE_ENABLED:-false}
      - GEOPULSE_OIDC_PROVIDER_GOOGLE_CLIENT_ID=${GEOPULSE_OIDC_PROVIDER_GOOGLE_CLIENT_ID:-}
      - GEOPULSE_OIDC_PROVIDER_GOOGLE_CLIENT_SECRET=${GEOPULSE_OIDC_PROVIDER_GOOGLE_CLIENT_SECRET:-}
      - GEOPULSE_OIDC_PROVIDER_GOOGLE_DISCOVERY_URL=${GEOPULSE_OIDC_PROVIDER_GOOGLE_DISCOVERY_URL:-https://accounts.google.com/.well-known/openid-configuration}
      - GEOPULSE_OIDC_PROVIDER_GENERIC_ENABLED=${GEOPULSE_OIDC_PROVIDER_GENERIC_ENABLED:-false}
      - GEOPULSE_OIDC_PROVIDER_GENERIC_NAME=${GEOPULSE_OIDC_PROVIDER_GENERIC_NAME:-}
      - GEOPULSE_OIDC_PROVIDER_GENERIC_CLIENT_ID=${GEOPULSE_OIDC_PROVIDER_GENERIC_CLIENT_ID:-}
      - GEOPULSE_OIDC_PROVIDER_GENERIC_CLIENT_SECRET=${GEOPULSE_OIDC_PROVIDER_GENERIC_CLIENT_SECRET:-}
      - GEOPULSE_OIDC_PROVIDER_GENERIC_DISCOVERY_URL=${GEOPULSE_OIDC_PROVIDER_GENERIC_DISCOVERY_URL:-}
    depends_on:
      geopulse-backend:
        condition: service_healthy
    labels:
      - joyride.host.name=${GEOPULSE_HOST_NAME:-geopulse}.${HOST_DOMAIN}
      - traefik.enable=${GEOPULSE_TRAEFIK_ENABLED:-true}
      - traefik.http.routers.geopulse.entrypoints=websecure
      - traefik.http.routers.geopulse.rule=Host(`${GEOPULSE_HOST_NAME:-geopulse}.${HOST_DOMAIN}`)
      - traefik.http.services.geopulse.loadbalancer.server.port=80
      - com.centurylinklabs.watchtower.enable=${GEOPULSE_WATCHTOWER_ENABLED:-true}
      - autoheal=${GEOPULSE_AUTOHEAL_ENABLED:-true}
