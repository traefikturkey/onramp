# description: Web-based ip address management (ipam) and data center infrastructure management (dcim) tool
# https://docs.linuxserver.io/images/docker-netbox
# database: postgres
# database_name: netbox
# cache: valkey
# cache_db: 8
networks:
  traefik:
    external: true

services:
  netbox:
    image: lscr.io/linuxserver/netbox:${NETBOX_DOCKER_TAG:-latest}
    container_name: ${NETBOX_CONTAINER_NAME:-netbox}
    restart: unless-stopped
    depends_on:
      - postgres
      - valkey
    healthcheck:
      start_period: 90s
    networks:
      - traefik
    volumes:
      - ./etc/netbox:/config # <==== this probably needs changed
      - /etc/localtime:/etc/localtime:ro
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
      - SKIP_SUPERUSER=false
      #Note: default username for the superuser is "admin", not the email address.
      - SUPERUSER_EMAIL=${NETBOX_SUPERUSER_EMAIL:-$CF_API_EMAIL}
      - SUPERUSER_PASSWORD=${NETBOX_SUPERUSER_PASS:-netbox}
      - ALLOWED_HOST=${NETBOX_CONTAINER_NAME:-netbox}.${HOST_DOMAIN}
      - DB_NAME=netbox
      - DB_USER=${PG_USER_NETBOX:-${PG_USER:-admin}}
      - DB_PASSWORD=${PG_PASS_NETBOX:-${PG_PASS}}
      - DB_HOST=postgres
      - REDIS_HOST=valkey
      - REDIS_DB_TASK=8
      - REDIS_DB_CACHE=8
    labels:
      - joyride.host.name=${NETBOX_CONTAINER_NAME:-netbox}.${HOST_DOMAIN}
      - traefik.enable=true
      - traefik.http.routers.netbox.entrypoints=websecure
      - traefik.http.routers.netbox.rule=Host(`${NETBOX_CONTAINER_NAME:-netbox}.${HOST_DOMAIN}`)
      - traefik.http.services.netbox.loadbalancer.server.scheme=http # enable if the service wants to connect over https
      - traefik.http.routers.netbox.service=netbox
      - traefik.http.services.netbox.loadbalancer.server.port=8000
      - com.centurylinklabs.watchtower.enable=${NETBOX_WATCHTOWER_ENABLED:-true}
      - autoheal=true
