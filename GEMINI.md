# OnRamp

Docker Compose-based self-hosted homelab. Traefik reverse proxy + Cloudflare DNS-01 SSL.

**Philosophy:** Disaster Recovery over High Availability. Rebuildable in minutes from backups.

## Project Structure

```
services-available/              # Docker Compose service definitions (*.yml)
services-enabled/                # Active symlinks + environment files
  ├── .env                       # Global (HOST_NAME, HOST_DOMAIN, TZ, PUID/PGID)
  ├── .env.nfs                   # NFS mount configuration
  ├── .env.external              # External service URLs
  └── <service>.env              # Per-service environment variables

services-scaffold/               # Templates that generate configs on enable
  ├── onramp/                    # Global .env templates
  └── <service>/                 # Per-service templates
      ├── env.template           # → services-enabled/<service>.env
      ├── *.template             # → etc/<service>/* (variable substitution)
      ├── *.static               # → etc/<service>/* (copied as-is)
      └── scaffold.yml           # Complex operations (keys, downloads)

etc/                             # Generated configs per service (persisted)
media/                           # Service data volumes
backups/                         # Backup archives
overrides-available/             # Optional service extensions
overrides-enabled/               # Active overrides
sietch/scripts/                  # Python tools (scaffold.py, backup.py, etc.)
make.d/                          # Makefile modules
docs/                            # User documentation
```

## Commands

### Services
```bash
make enable-service NAME      # Enable + scaffold
make disable-service NAME     # Disable (keeps etc/ data)
make start-service NAME       # Start container
make stop-service NAME        # Stop container
make restart-service NAME     # Restart container
make logs NAME                # View logs
make nuke-service NAME        # Remove service AND all data
make attach-service NAME      # Exec bash into container
make update-service NAME      # Pull + restart single service
```

### Environment
```bash
make edit-env-onramp          # Edit global .env (HOST_NAME, HOST_DOMAIN)
make edit-env-nfs             # Edit NFS mounts
make edit-env-external        # Edit external service URLs
make edit-env NAME            # Edit service-specific .env
```

### Scaffolding
```bash
make scaffold-build NAME      # Re-run scaffold templates
make scaffold-list            # List services with scaffolds
make scaffold-check NAME      # Validate scaffold exists
```

### Listing
```bash
make list-services            # All available services
make list-enabled             # Currently enabled services
make list-overrides           # Available overrides
make list-external            # External service proxies
make list-games               # Game servers
```

### Utilities
```bash
make check-yaml               # Validate all YAML files
make start-staging            # Use ACME staging certs
make create-backup            # Backup configuration
make restore-backup           # Restore from backup
make test                     # Run pytest suite
```

## How Scaffolding Works

When you run `make enable-service <name>`:

1. Creates symlink: `services-available/<name>.yml` → `services-enabled/`
2. Looks for `services-scaffold/<name>/` directory
3. If `env.template` exists → generates `services-enabled/<name>.env`
4. Copies `*.template` files to `etc/<name>/` with variable substitution
5. Copies `*.static` files to `etc/<name>/` as-is
6. Executes `scaffold.yml` operations if present

**If no scaffold exists**, only the symlink is created. The service may fail if it requires environment variables.

## Troubleshooting

### "cannot open your_server_name" Error
Global `.env` has placeholder values. Fix with:
```bash
make edit-env-onramp
# Change: HOST_NAME=<your_server_name> → HOST_NAME=myserver
# Change: HOST_DOMAIN=<your_domain.com> → HOST_DOMAIN=example.com
```

### No .env Created for Service
Service missing scaffold templates:
1. Check if `services-scaffold/<service>/` exists
2. If not, create `services-scaffold/<service>/env.template`
3. Run `make scaffold-build <service>`

### Service Can't Connect to Database
Check service YAML has database connection environment variables:
```yaml
environment:
  - HOST=db
  - USER=${SERVICE_POSTGRES_USER:-service}
  - PASSWORD=${SERVICE_POSTGRES_DB_PW}
```

### Finding Original .env Values After Migration
```bash
cat backups/environments-enabled.legacy/.env
```

## Adding Services

1. Create `services-available/<name>.yml`
2. Create `services-scaffold/<name>/env.template` (required if service needs config)
3. `make enable-service <name>`

## Generated Files (Do Not Edit Directly)

- `SERVICES.md` - Generated by `.githooks/generate-services-markdown.sh`
  - To fix: Edit the generator script or service YAML `# description:` comments
  - Regenerate: Run the script or commit (pre-commit hook)

## Environment File Precedence

1. Service-specific: `services-enabled/<service>.env`
2. Global overrides: `services-enabled/.env.nfs`, `.env.external`
3. Main config: `services-enabled/.env`

## Resources

For detailed documentation:
- **Commands**: `docs/commands.md`
- **External Services**: `docs/external-services.md`
- **Overrides**: `docs/overrides.md`
- **Scaffolding**: `docs/scaffolding.md`
- **Troubleshooting**: `docs/troubleshooting.md`

Architecture docs in `.github/shared/`:
- `scaffold-templates.md` - Scaffold file conventions and operations
- `makefile-modules.md` - All 88 make targets with quick reference
- `sietch-scripts.md` - Python tools and IoC architecture
- `troubleshooting.md` - Extended troubleshooting guide

## Conventions

- Templates: `*.template` (variable substitution) or `*.static` (copy as-is)
- Env vars: `${VAR:-default}` pattern
- Services with databases: Use dedicated containers (e.g., `db` or `<service>-db`)

## Guardrails

- Always use `make` commands, never raw `docker compose`
- Do not create files without explicit user request
- Commit all changes when asked (clean `git status`)
