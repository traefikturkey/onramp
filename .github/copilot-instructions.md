# OnRamp

Docker Compose-based self-hosted homelab. Traefik reverse proxy + Cloudflare DNS-01 SSL.

**Philosophy:** Disaster Recovery over High Availability. Rebuildable in minutes from backups.

## Project Structure

```
services-available/              # Service definitions (*.yml)
services-enabled/                # Active symlinks + environment files
  ├── .env                       # Global (HOST_NAME, HOST_DOMAIN, TZ, PUID/PGID)
  ├── .env.nfs                   # NFS mount paths
  ├── .env.external              # External service URLs
  └── <service>.env              # Per-service variables
services-scaffold/<service>/     # Templates → generates env + configs
etc/                             # Generated configs per service
media/                           # Service data volumes
backups/                         # Backup archives + migration backups
overrides-available/             # Optional service extensions
overrides-enabled/               # Active overrides
sietch/scripts/                  # Python tools
```

## Key Commands

| Task | Command |
|------|---------|
| Enable service | `make enable-service NAME` |
| Start service | `make start-service NAME` |
| View logs | `make logs NAME` |
| Edit global env | `make edit-env-onramp` |
| Edit NFS config | `make edit-env-nfs` |
| Edit external URLs | `make edit-env-external` |
| Edit service env | `make edit-env NAME` |
| Rebuild scaffold | `make scaffold-build NAME` |
| List services | `make list-services` |
| List overrides | `make list-overrides` |
| List external | `make list-external` |
| Attach to container | `make attach-service NAME` |
| Validate YAML | `make check-yaml` |

## How Scaffolding Works

`make enable-service <name>`:
1. Creates symlink to `services-enabled/`
2. If `services-scaffold/<name>/env.template` exists → generates `services-enabled/<name>.env`
3. Copies templates to `etc/<name>/`

**No scaffold = no .env generated.** Service may fail if it needs config.

## Common Troubleshooting

### "cannot open your_server_name" Error
Global `.env` has placeholder values:
```bash
make edit-env-onramp
# Fix: HOST_NAME=<your_server_name> → HOST_NAME=myserver
```

### No .env Created
Missing scaffold - create `services-scaffold/<service>/env.template`

### Database Connection Failed
Service YAML missing env vars:
```yaml
environment:
  - HOST=db
  - USER=${SERVICE_POSTGRES_USER}
  - PASSWORD=${SERVICE_POSTGRES_DB_PW}
```

### Find Original .env After Migration
```bash
cat backups/environments-enabled.legacy/.env
```

## Generated Files (Do Not Edit Directly)

- `SERVICES.md` - Generated by `.githooks/generate-services-markdown.sh`
  - To fix: Edit the generator script or service YAML `# description:` comments

## Environment File Precedence

1. Service-specific: `services-enabled/<service>.env`
2. Global overrides: `services-enabled/.env.nfs`, `.env.external`
3. Main config: `services-enabled/.env`

## Copilot Resources

- **Path-scoped**: `.github/instructions/*.instructions.md`
- **Architecture docs**: `.github/shared/*.md`
- **User docs**: `docs/` directory
- **Full context**: `.claude/CLAUDE.md`

## Guardrails

- Always use `make` commands, never raw `docker compose`
- Do not create files without explicit user request
